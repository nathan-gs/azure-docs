---
title: 'Azure Active Directory B2C: Troubleshooting Custom Policies | Microsoft Docs'
description: A guide to several approaches to solve errors in custom policies
services: active-directory-b2c
documentationcenter: ''
author: rojasja
manager: krassk
editor: rojasja

ms.assetid: 
ms.service: active-directory-b2c
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/07/2017
ms.author: joroja

---
# Azure Active Directory B2C Custom Policies and Identity Experience Framework Troubleshooting
## The basics

Identity developers using Azure AD B2C Custom Policies are challenged to configure the Identity Experience Framework in its policy language in the XML format.  This guide is both list of recommended tools and tips to discover and resolve issues quickly.  Learning to write Custom Policies is similar to learning a new language.  
*This article is focused on troubleshooting your Azure AD B2C Cusutom Policy configuration and not the relying party application or its identity library.*



## XML Editing, inproperly formatted XML is the most common error.

A good XML editor which displays XML natively, color codes content, pre-fills common terms, keeps XML elements indexed, and can validate with schema is nearly essential.  Here are two of our favorites.

* [VS Code](https://code.visualstudio.com/)
* [Notepad++](https://notepad-plus-plus.org/)

Get the XML schema definition `TrustFrameworkPolicy_0.3.0.0.xsd` from the root folder of the starter pack. XML schema validation identifies errors before uploading.  Look in the documentation of your XML editor for `XML tools` and `XML Validation`

A quick review of the rules of XML may be very valuable since Azure AD B2C will reject any formatting errors it detects.  Ocassionally, uncorrectly formatted XML may result in error messages that are misleading.

## Uploading policies and policy validation

 **Upload** validation is automatic and most errors will result in aborting an upload.  **Keep in mind that the validation includes the policy file you are trying to upload and includes the chain of files it refers to.  `RP policy file > Extensions file > Base File`  Common validation errors include:

Error snippet: `... makes a reference to ClaimType with id "displaName" but neither the policy nor any of its base policies contain such an element`
* The claimType may be misspelled, or does not exist in the Schema.
* ClaimTypes must be defined in at least one of the files in the policy.  For example ` <ClaimType Id="socialIdpUserId">`
* If the ClaimType is defined in the extensions file, but used in a TechnichalProfile in the base file, uploading the base file will result in an error.

Error snippet: `...males a reference to a ClaimsTransformation with id...`
* Same as above.

Error snippet: `Reason: User is currently logged as a user of 'yourtenant.onmicrosoft.com' tenant. In order to manage 'yourtenant.onmicrosoft.com', please login as a user of 'yourtenant.onmicrosoft.com' tenant`
* Check that the TenantId in the **<TrustFrameworkPolicy>** and the **<BasePolicy>** elements match your target B2C tenant.  



## Runtime troubleshooting

* Use `Run Now` and `https://jwt.io` to test your policies indepently of your web or mobile application. This website acts like a relying party application and displayes the contents of the JWT token generated by your Azure AD B2C policy.  To create a test application in Identity Experience Framework.
    * Name: TestApp
    * Web App / web API: No
    * Native client: No

* Use [fiddler](http://www.telerik.com/fiddler) to trace the exchange of messages between your client browser and Azure AD B2C.  You will gain an indication of where in your orchestration steps is your userjourney failing.

* Use **Application Insights** under **Development mode** to trace the behavior of your Identity Experience Framework (IEF) user journey.  In **Development mode** it is possible to observe the exchange of claims between the IEF and the various Claims Providers defined by TechnicalProfiles, such as identity providers, API-bases services, the Azure AD B2C user directory (AAD Directory), and other services like Multi-Factor-Authentication.  

## Recommended practies

**Keep multiple versions of your scenarios and group them in a project with your application.** The base, extensions, and relying party (RP) files are directly dependent on each other, save them as a group and keep separate working versions as new features are realized in your policies.  Stage them in your own file system with the application code with which they interact.  Your applications may invoke may different RP policies in a tenant and become dependent on the claims they expect from your Azure AD B2C policies.

**Develop and test Technical Profiles with known user journeys.**  Use tested Starter Pack policies to configure your Technical Profiles and test them separately before incorporating into your own user journeys

**Develop and test user journeys with tested Technical Profiles** Change the orchestration steps of a user journey step by step, progressively building your desired scenarios







Let's get started:

1. Download the "active-directory-b2c-custom-policy-starterpack" from GitHub.  [Download the zip](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) or run
### Built-in



The extensible policy framework of Azure Active Directory (Azure AD) B2C is the core strength of the service. Policies fully describe consumer identity experiences such as sign-up, sign-in or profile editing. For instance, a sign-up policy allows you to control behaviors by configuring the following settings:

* Account types (social accounts such as Facebook, or local accounts such as email address) that consumers can use to sign up for the application.
* Attributes (for example, first name, postal code, and shoe size) to be collected from the consumer during sign-up.
* Use of Multi-Factor Authentication.
* The look-and-feel of all sign-up pages.
* Information (which manifests as claims in a token) that the application receives when the policy run finishes.

You can create multiple policies of different types in your tenant and use them in your applications as needed. Policies can be reused across applications. This allows developers to define and modify consumer identity experiences with minimal or no changes to their code.

Policies are available for use via a simple developer interface. Your application triggers a policy using a standard HTTP authentication request (passing a policy parameter in the request) and receives a customized token as response. For example, the only difference between requests invoking a sign-up policy and those invoking a sign-in policy is the policy name used in the "p" query string parameter:

```

https://login.microsoftonline.com/contosob2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application ID
&redirect_uri=https%3A%2F%2Flocalhost%3A44321%2F    // Your registered Reply URL, url encoded
&response_mode=form_post                            // 'query', 'form_post' or 'fragment'
&response_type=id_token
&scope=openid
&nonce=dummy
&state=12345                                        // Any value provided by your application
&p=b2c_1_siup                                       // Your sign-up policy

```

```

https://login.microsoftonline.com/contosob2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application ID
&redirect_uri=https%3A%2F%2Flocalhost%3A44321%2F    // Your registered Reply URL, url encoded
&response_mode=form_post                            // 'query', 'form_post' or 'fragment'
&response_type=id_token
&scope=openid
&nonce=dummy
&state=12345                                        // Any value provided by your application
&p=b2c_1_siin                                       // Your sign-in policy

```

For more details about the policy framework, see this [blog post](http://blogs.technet.com/b/ad/archive/2015/11/02/a-look-inside-azuread-b2c-with-kim-cameron.aspx).

## Create a sign-up policy
To enable sign-up on your application, you will need to create a sign-up policy. This policy describes the experiences that consumers will go through during sign-up and the contents of tokens that the application will receive on successful sign-ups.

1. [Follow these steps to navigate to the B2C features blade on the Azure portal](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Click **Sign-up policies**.
3. Click **+Add** at the top of the blade.
4. The **Name** determines the sign-up policy name used by your application. For example, enter "SiUp".
5. Click **Identity providers** and select "Email signup". Optionally, you can also select social identity providers, if already configured. Click **OK**.
6. Click **Sign-up attributes**. Here you choose attributes that you want to collect from the consumer during sign-up. For example, select "Country/Region", "Display Name" and "Postal Code". Click **OK**.
7. Click **Application claims**. Here you choose claims that you want returned in the tokens sent back to your application after a successful sign-up experience. For example, select "Display Name", "Identity Provider", "Postal Code", "User is new" and "User's Object ID".
8. Click **Create**. Note that the policy just created appears as "**B2C_1_SiUp**" (the **B2C\_1\_** fragment is automatically added) in the **Sign-up policies** blade.
9. Open the policy by clicking "**B2C_1_SiUp**".
10. Select "Contoso B2C app" in the **Applications** drop-down and `https://localhost:44321/` in the **Reply URL / Redirect URI** drop-down.
11. Click **Run now**. A new browser tab opens, and you can run through the consumer experience of signing up for your application.
    
    > [!NOTE]
    > It takes up to a minute for policy creation and updates to take effect.
    > 
    > 

## Create a sign-in policy
To enable sign-in on your application, you will need to create a sign-in policy. This policy describes the experiences that consumers will go through during sign-in and the contents of tokens that the application will receive on successful sign-ins.

1. [Follow these steps to navigate to the B2C features blade on the Azure portal](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Click **Sign-in policies**.
3. Click **+Add** at the top of the blade.
4. The **Name** determines the sign-in policy name used by your application. For example, enter "SiIn".
5. Click **Identity providers** and select "Local Account SignIn". Optionally, you can also select social identity providers, if already configured. Click **OK**.
6. Click **Application claims**. Here you choose claims that you want returned in the tokens sent back to your application after a successful sign-in experience. For example, select "Display Name", "Identity Provider", "Postal Code"  and "User's Object ID". Click **OK**.
7. Click **Create**. Note that the policy just created appears as "**B2C_1_SiIn**" (the **B2C\_1\_** fragment is automatically added) in the **Sign-in policies** blade.
8. Open the policy by clicking "**B2C_1_SiIn**".
9. Select "Contoso B2C app" in the **Applications** drop-down and `https://localhost:44321/` in the **Reply URL / Redirect URI** drop-down.
10. Click **Run now**. A new browser tab opens, and you can run through the consumer experience of signing into your application.
    
    > [!NOTE]
    > It takes up to a minute for policy creation and updates to take effect.
    > 
    > 

## Create a sign-up or sign-in policy
This policy handles both consumer sign-up & sign-in experiences with a single configuration. Consumers are led down the right path (sign-up or sign-in) depending on the context. It also describes the contents of tokens that the application will receive upon successful sign-ups or sign-ins.  A code sample for the sign-up or sign-in policy is [available here](active-directory-b2c-devquickstarts-web-dotnet-susi.md).

1. [Follow these steps to navigate to the B2C features blade on the Azure portal](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Click **Sign-up or sign-in policies**.
3. Click **+Add** at the top of the blade.
4. The **Name** determines the sign-up policy name used by your application. For example, enter "SiUpIn".
5. Click **Identity providers** and select "Email signup". Optionally, you can also select social identity providers, if already configured. Click **OK**.
6. Click **Sign-up attributes**. Here you choose attributes that you want to collect from the consumer during sign-up. For example, select "Country/Region", "Display Name" and "Postal Code". Click **OK**.
7. Click **Application claims**. Here you choose claims that you want returned in the tokens sent back to your application after a successful sign-up or sign-in experience. For example, select "Display Name", "Identity Provider", "Postal Code", "User is new" and "User's Object ID".
8. Click **Create**. Note that the policy just created appears as "**B2C_1_SiUpIn**" (the **B2C\_1\_** fragment is automatically added) in the **Sign-up or sign-in policies** blade.
9. Open the policy by clicking "**B2C_1_SiUpIn**".
10. Select "Contoso B2C app" in the **Applications** drop-down and `https://localhost:44321/` in the **Reply URL / Redirect URI** drop-down.
11. Click **Run now**. A new browser tab opens, and you can run through the sign-up or sign-in consumer experience as configured.
    
    > [!NOTE]
    > It takes up to a minute for policy creation and updates to take effect.
    > 
    > 

## Create a profile editing policy
To enable profile editing on your application, you will need to create a profile editing policy. This policy describes the experiences that consumers will go through during profile editing and the contents of tokens that the application will receive on successful completion.

1. [Follow these steps to navigate to the B2C features blade on the Azure portal](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Click **Profile editing policies**.
3. Click **+Add** at the top of the blade.
4. The **Name** determines the profile editing policy name used by your application. For example, enter "SiPe".
5. Click **Identity providers** and select "Local Account Signin". Optionally, you can also select social identity providers, if already configured. Click **OK**.
6. Click **Profile attributes**. Here you choose attributes that the consumer can view and edit. For example, select "Country/Region", "Display Name", and "Postal Code". Click **OK**.
7. Click **Application claims**. Here you choose claims that you want returned in the tokens sent back to your application after a successful profile editing experience. For example, select "Display Name" and "Postal Code".
8. Click **Create**. Note that the policy just created appears as "**B2C_1_SiPe**" (the **B2C\_1\_** fragment is automatically added) in the **Profile editing policies** blade.
9. Open the policy by clicking "**B2C_1_SiPe**".
10. Select "Contoso B2C app" in the **Applications** drop-down and `https://localhost:44321/` in the **Reply URL / Redirect URI** drop-down.
11. Click **Run now**. A new browser tab opens, and you can run through the profile editing consumer experience in your application.
    
    > [!NOTE]
    > It takes up to a minute for policy creation and updates to take effect.
    > 
    > 

## Create a password reset policy
To enable fine-grained password reset on your application, you will need to create a password reset policy. Note that the tenant-wide password reset option specified [here](active-directory-b2c-reference-sspr.md) is still applicable for sign-in policies. This policy describes the experiences that the consumers will go through during password reset and the contents of tokens that the application will receive on successful completion.

1. [Follow these steps to navigate to the B2C features blade on the Azure portal](active-directory-b2c-app-registration.md#navigate-to-the-b2c-features-blade).
2. Click **Password reset policies**.
3. Click **+Add** at the top of the blade.
4. The **Name** determines the password reset policy name used by your application. For example, enter "SSPR".
5. Click **Identity providers** and select "Reset password using email address". Click **OK**.
6. Click **Application claims**. Here you choose claims that you want returned in the tokens sent back to your application after a successful password reset experience. For example, select "User's Object ID".
7. Click **Create**. Note that the policy just created appears as "**B2C_1_SSPR**" (the **B2C\_1\_** fragment is automatically added) in the **Password reset policies** blade.
8. Open the policy by clicking "**B2C_1_SSPR**".
9. Select "Contoso B2C app" in the **Applications** drop-down and `https://localhost:44321/` in the **Reply URL / Redirect URI** drop-down.
10. Click **Run now**. A new browser tab opens, and you can run through the password reset consumer experience in your application.
    
    > [!NOTE]
    > It takes up to a minute for policy creation and updates to take effect.
    > 
    > 

## How to link a sign-up or sign-in policy with a password reset policy?
When you create a sign-up or sign-in policy (with local accounts), the consumer will see a "Forgot password?" link on the first page of the experience. Clicking on this link doesn't automatically trigger a password reset policy. Instead a specific error code `AADB2C90118` is returned back to your app. Your app needs to handle this and invoke a specific password reset policy. A sample that demonstrates this approach of linking together policies is [here](https://github.com/AzureADQuickStarts/B2C-WebApp-OpenIDConnect-DotNet-SUSI).

## Additional resources
* [Token, session and single sign-on configuration](active-directory-b2c-token-session-sso.md).
* [Disable email verification during consumer sign-up](active-directory-b2c-reference-disable-ev.md)

